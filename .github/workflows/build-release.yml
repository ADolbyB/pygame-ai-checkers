name: Build & Release Pygame Checkers

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # JOB 1: Build Windows executable
  build-windows:
    runs-on: windows-latest
    
    steps:
      # Step 1: Check out the repository code
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Step 2: Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # Use a recent stable Python version
      
      # Step 3: Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pygame pyinstaller
      
      # Step 4: Build Windows executable with PyInstaller
      - name: Build Windows executable
        run: |
          pyinstaller --onefile --windowed --name="Checkers-Game" checkersMain.py
      
      # Step 5: Create Windows distribution package
      - name: Package Windows distribution
        run: |
          mkdir Checkers-Windows
          copy dist\Checkers-Game.exe Checkers-Windows\
          # Copy necessary assets if they're not bundled
          if (Test-Path assets) { xcopy assets Checkers-Windows\assets\ /E /I }
          if (Test-Path README.md) { copy README.md Checkers-Windows\ }
          
          # Create ZIP archive
          Compress-Archive -Path Checkers-Windows\* -DestinationPath Checkers-Windows-x64.zip
      
      # Step 6: Upload Windows build as artifact
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: Checkers-Windows-x64.zip
          retention-days: 1

  # JOB 2: Build Linux executable
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Check out the repository code
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Step 2: Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # Step 3: Install system dependencies for Pygame
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-dev libsdl2-dev libsdl2-image-dev \
            libsdl2-mixer-dev libsdl2-ttf-dev libfreetype6-dev \
            libportmidi-dev libjpeg-dev
      
      # Step 4: Install Python dependencies
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pygame pyinstaller
      
      # Step 5: Build Linux executable with PyInstaller
      - name: Build Linux executable
        run: |
          pyinstaller --onefile --add-data "checkers:checkers" \
            --name="Checkers-Game" checkersMain.py
        continue-on-error: false  # Make sure we see errors
      
      # Step 6: Verify executable is built
      - name: Verify build
        run: |
          echo "=== Checking dist folder ==="
          ls -la dist/
          if [ ! -f "dist/Checkers-Game" ]; then
            echo "ERROR: Executable not found!"
            exit 1
          fi
      
      # Step 7: Create Linux distribution package
      - name: Package Linux distribution
        run: |
          mkdir -p Checkers-Linux
          cp dist/Checkers-Game Checkers-Linux/
          chmod +x Checkers-Linux/Checkers-Game
          
          # Copy assets if they're not bundled
          if [ -d "assets" ]; then
            cp -r assets Checkers-Linux/
          fi
          if [ -f "README.md" ]; then
            cp README.md Checkers-Linux/
          fi
          
          # Create installation script
          cat > Checkers-Linux/run.sh << 'EOF'
            #!/bin/bash
            # Checkers Game Launcher
            cd "$(dirname "$0")"
            ./Checkers-Game
            EOF
          chmod +x Checkers-Linux/run.sh
          
          # Create tarball
          tar -czf Checkers-Linux-x64.tar.gz Checkers-Linux/
      
      # Step 8: Upload Linux build as artifact
      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: Checkers-Linux-x64.tar.gz
          retention-days: 1

  # JOB 3: Create GitHub Release with all builds
  create-release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Check out repository
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Step 2: Download all build artifacts
      - name: Download Windows build
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: builds
      
      - name: Download Linux build
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: builds
      
      # Step 3: List downloaded files for verification
      - name: List build files
        run: |
          echo "=== Build artifacts ==="
          ls -lh builds/
      
      # Step 4: Create the GitHub release
      - name: Create Release & Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Pygame Checkers ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: false
          body: |
            ðŸŽ® **Pygame AI Checkers - Release ${{ github.ref_name }}**
            
            An AI-powered checkers game built with Python and Pygame featuring minimax algorithm.
            
            ## ðŸ“¦ Downloads
            
            ### Windows (64-bit)
            - `Checkers-Windows-x64.zip` - Extract and run `Checkers-Game.exe`
            
            ### Linux (64-bit)
            - `Checkers-Linux-x64.tar.gz` - Extract and run `./run.sh`
            
            ## ðŸŽ¯ Features
            - Play against Minimax AI opponent
            - Multiple difficulty levels
            - Clean, intuitive interface
            
            ## ðŸš€ Quick Start
            
            **Windows:**
            1. Download `Checkers-Windows-x64.zip`
            2. Extract the ZIP file
            3. Double-click `Checkers-Game.exe`
            4. Enjoy!
            
            **Linux:**
            Download `Checkers-Linux-x64.tar.gz`

            ```bash
            # Extract
            tar -xzf Checkers-Linux-x64.tar.gz
            cd Checkers-Linux
            
            # Run the game
            ./run.sh
            # OR
            ./Checkers-Game
            ```
            
            ## ðŸ’» Running from Source
            ```bash
            # Clone the repository
            git clone https://github.com/ADolbyB/pygame-ai-checkers.git
            cd pygame-ai-checkers
            
            # Install dependencies
            pip install pygame
            
            # Run the game
            python checkers.py
            ```
            
            ## ðŸ”§ System Requirements
            
            - **Windows:** Windows 10 or later (64-bit)
            - **Linux:** Ubuntu 20.04+ or equivalent (64-bit)
            - **RAM:** 512 MB minimum
            - **Display:** 800x600 minimum resolution
            
            ---
            
            **Build Information:**
            - Python Version: 3.11
            - Pygame Version: Latest
            - Commit: ${{ github.sha }}
          files: |
            builds/Checkers-Windows-x64.zip
            builds/Checkers-Linux-x64.tar.gz
          fail_on_unmatched_files: true